<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šå³æ™‚æŠ•ç¥¨ç³»çµ±</title>
    <!-- ä½¿ç”¨ Tailwind CSS ä»¥å¯¦ç¾éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Font Awesome åœ–ç¤ºåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* è‡ªå®šç¾©é•·æ¢åœ–å‹•ç•«æ•ˆæœ */
        .bar-chart-bar {
            transition: width 0.5s ease-in-out;
        }

        /* è‡ªå®šç¾©å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="text-center my-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">ç·šä¸Šå³æ™‚æŠ•ç¥¨ç³»çµ±</h1>
            <p class="mt-2 text-md md:text-lg text-gray-600">è«‹å¾ä»¥ä¸‹å€™é¸äººä¸­é¸æ“‡ã€‚</p>
        </header>

        <!-- æŠ•ç¥¨å€å¡Š -->
        <section id="voting-section" class="mb-12">
            <div id="candidates-grid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 justify-center">
                <!-- å€™é¸äººå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </section>

        <!-- æŠ•ç¥¨çµæœå€å¡Š -->
        <section id="results-section" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">å³æ™‚æŠ•ç¥¨çµæœ</h2>
            <div id="results-placeholder" class="text-center text-gray-500 text-lg py-4" style="display: none;">
                å°šç„¡æŠ•ç¥¨çµæœã€‚
            </div>
            <div id="bar-chart-container" class="space-y-4">
                <!-- é•·æ¢åœ–å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ç®¡ç†é¢æ¿å€å¡Š -->
        <section id="admin-login" class="bg-gray-200 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">ç®¡ç†é¢æ¿</h2>
            <div class="flex flex-col items-center">
                <input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    class="p-2 border border-gray-300 rounded-md w-full max-w-sm mb-4 text-center">
                <button id="admin-login-btn"
                    class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors w-full max-w-sm">ç™»å…¥ç®¡ç†å“¡</button>
            </div>
        </section>

        <section id="admin-panel" class="bg-gray-200 p-6 rounded-lg shadow-lg mt-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">ç®¡ç†é¢æ¿</h2>
            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <div class="flex-grow">
                    <textarea id="candidate-names" rows="5"
                        class="p-2 border border-gray-300 rounded-md w-full resize-none"
                        placeholder="è¼¸å…¥å€™é¸äººå§“åï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹å¦‚:&#10;ç‹å°æ˜&#10;é™³å¤§è¯"></textarea>
                    <button id="add-candidates-btn"
                        class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition-colors w-full mt-2">æ–°å¢å€™é¸äºº</button>
                </div>
                <div class="flex-shrink-0 mt-4 md:mt-0">
                    <button id="clear-data-btn"
                        class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-colors w-full h-full">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </section>
    </div>

    <!-- è‡ªå®šç¾©å½ˆå‡ºè¦–çª—ï¼ˆå–ä»£ alertï¼‰ -->
    <div id="modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center flex flex-col">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-close-btn"
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">ç¢ºèª</button>
                <button id="modal-cancel-btn"
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors"
                    style="display: none;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // åœ¨é€™è£¡æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®š
        // æ‚¨å¯ä»¥åœ¨ Firebase Console ä¸­æ‰¾åˆ°é€™äº›è³‡è¨Šï¼šå°ˆæ¡ˆè¨­å®š > æ‚¨çš„æ‡‰ç”¨ç¨‹å¼
        // ğŸš¨ æ­¥é©Ÿä¸€ï¼šè«‹å‹™å¿…ç”¨æ‚¨è‡ªå·±çš„ Firebase æ†‘è­‰æ›¿æ›ä»¥ä¸‹ä½”ä½ç¬¦ï¼
        const firebaseConfig = {
            apiKey: "AIzaSyAury4xL1VDeszAT8fYTvtyrmHGEFpcp4Y",
            authDomain: "poll-76c08.firebaseapp.com",
            projectId: "poll-76c08",
            storageBucket: "poll-76c08.firebasestorage.app",
            messagingSenderId: "626238322094",
            appId: "1:626238322094:web:98a6dfd2b4eb1fa1ae443f"
        };
        const appIdentifier = "1:626238322094:web:98a6dfd2b4eb1fa1ae443f";
        
        // åˆå§‹åŒ– Firebase
        let app, db, auth;
        let userId = '';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase æ‡‰ç”¨ç¨‹å¼èˆ‡ Firestore å·²åˆå§‹åŒ–ã€‚");
        } catch (error) {
            console.error("åˆå§‹åŒ– Firebase å¤±æ•—: ", error);
        }

        // DOM å…ƒç´ å¿«å–
        const candidatesGrid = document.getElementById('candidates-grid');
        const barChartContainer = document.getElementById('bar-chart-container');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginSection = document.getElementById('admin-login');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminPanelSection = document.getElementById('admin-panel');
        const addCandidatesBtn = document.getElementById('add-candidates-btn');
        const candidateNamesTextarea = document.getElementById('candidate-names');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // ç®¡ç†å“¡å¯†ç¢¼
        const ADMIN_PASSWORD = "weses3974893";

        // é¡¯ç¤ºè‡ªå®šç¾©å½ˆå‡ºè¦–çª—
        function showModal(message, isConfirmation = false, onConfirm = null) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';

            if (isConfirmation) {
                modalCloseBtn.textContent = 'ç¢ºå®šæ¸…é™¤';
                modalCancelBtn.style.display = 'inline-block';
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ä»¥é¿å…é‡è¤‡è§¸ç™¼
                modalCloseBtn.onclick = null;
                modalCancelBtn.onclick = null;
                modalCloseBtn.onclick = () => {
                    modal.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
                modalCancelBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modalCloseBtn.textContent = 'ç¢ºèª';
                modalCancelBtn.style.display = 'none';
                modalCloseBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            }
        }

        // ç›£è½ Firebase èº«ä»½é©—è­‰ç‹€æ…‹è®ŠåŒ–
        async function authenticateUser() {
            try {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("ç”¨æˆ¶å·²é©—è­‰ï¼ŒID:", userId);
                // æˆåŠŸç™»å…¥å¾Œï¼Œé¡¯ç¤ºæç¤º
                showModal("é©—è­‰æˆåŠŸï¼Œæ‚¨å¯ä»¥é–‹å§‹æŠ•ç¥¨ã€‚");
            } catch (error) {
                console.error("èº«ä»½é©—è­‰å¤±æ•—: ", error);
                userId = crypto.randomUUID();
                console.log("èº«ä»½é©—è­‰å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID:", userId);
                showModal("é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Firebase Authentication è¨­å®šã€‚");
            }

            // å•Ÿå‹• Firestore ç›£è½å™¨
            startFirestoreListeners();
        }

        // å•Ÿå‹• Firestore ç›£è½å™¨ä»¥å¯¦ç¾å³æ™‚æ›´æ–°
        function startFirestoreListeners() {
            if (!db || !userId) {
                console.error("Firestore æˆ–ç”¨æˆ¶IDä¸å¯ç”¨ã€‚");
                return;
            }

            // å°‡è·¯å¾‘æ”¹ç‚ºé ‚å±¤é›†åˆ
            const candidatesCollectionRef = collection(db, `candidates`);
            
            // ç›£è½å€™é¸äººè³‡æ–™çš„å³æ™‚è®ŠåŒ–
            onSnapshot(candidatesCollectionRef, (snapshot) => {
                const candidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI(candidates);
            }, (error) => {
                console.error("ç›£è½å€™é¸äººè³‡æ–™å¤±æ•—: ", error);
            });
        }

        // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢ï¼ˆå€™é¸äººå¡ç‰‡å’Œé•·æ¢åœ–ï¼‰
        function updateUI(candidates) {
            // æ›´æ–°å€™é¸äººå¡ç‰‡
            candidatesGrid.innerHTML = '';
            candidates.forEach(candidate => {
                const card = createCandidateCard(candidate);
                candidatesGrid.appendChild(card);
            });

            // æ›´æ–°é•·æ¢åœ–
            renderBarChart(candidates);
        }

        // æ¸²æŸ“é•·æ¢åœ–
        function renderBarChart(candidates) {
            barChartContainer.innerHTML = '';
            if (candidates.length === 0 || candidates.every(c => c.votes === 0)) {
                resultsPlaceholder.style.display = 'block';
                return;
            } else {
                resultsPlaceholder.style.display = 'none';
            }

            const totalVotes = candidates.reduce((sum, c) => sum + (c.votes || 0), 0);
            candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

            candidates.forEach(candidate => {
                const voteCount = candidate.votes || 0;
                const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;

                const barElement = document.createElement('div');
                barElement.className = 'flex items-center space-x-4';
                barElement.innerHTML = `
                    <div class="w-1/4 text-right pr-4 text-gray-700 font-medium">${candidate.name}</div>
                    <div class="relative w-3/4 bg-gray-300 rounded-lg h-8">
                        <div class="bar-chart-bar bg-blue-500 rounded-lg h-full absolute left-0 top-0" style="width: ${percentage}%;"></div>
                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-white text-sm font-bold drop-shadow-md">
                            ${voteCount} ç¥¨ (${percentage.toFixed(1)}%)
                        </span>
                    </div>
                `;
                barChartContainer.appendChild(barElement);
            });
        }

        // éš¨æ©Ÿç”¢ç”Ÿåå…­é€²ä½é¡è‰²ä»£ç¢¼
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // å»ºç«‹å€™é¸äººå¡ç‰‡ DOM å…ƒç´ 
        function createCandidateCard(candidate) {
            const firstChar = candidate.name.charAt(0);
            const randomColor = getRandomColor();
            const imageUrl = `https://placehold.co/96x96/${randomColor}/FFFFFF?text=${encodeURIComponent(firstChar)}`;

            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center';
            card.innerHTML = `
                <div class="w-24 h-24 rounded-full overflow-hidden flex items-center justify-center text-3xl text-gray-600 mb-4">
                    <img src="${imageUrl}" alt="${candidate.name}" class="w-full h-full object-cover">
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">${candidate.name}</h3>
                <button data-candidate-id="${candidate.id}"
                    class="vote-btn bg-blue-500 text-white px-6 py-2 rounded-full hover:bg-blue-600 transition-colors">
                    æŠ•ç¥¨
                </button>
            `;
            const voteBtn = card.querySelector('.vote-btn');
            voteBtn.addEventListener('click', () => handleVote(candidate.id, candidate.name));
            return card;
        }

        // è™•ç†æŠ•ç¥¨é‚è¼¯
        async function handleVote(candidateId, candidateName) {
            if (!userId) {
                showModal("æ­£åœ¨é©—è­‰èº«ä»½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                return;
            }
            
            // å°‡è·¯å¾‘æ”¹ç‚ºé ‚å±¤é›†åˆ
            const usersCollectionRef = collection(db, `users`);
            const candidatesCollectionRef = collection(db, `candidates`);

            const userVoteDocRef = doc(usersCollectionRef, userId);
            const candidateDocRef = doc(candidatesCollectionRef, candidateId);

            try {
                // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²æŠ•ç¥¨
                const userVoteDoc = await getDoc(userVoteDocRef);
                if (userVoteDoc.exists()) {
                    showModal("æ‚¨å·²ç¶“æŠ•éç¥¨äº†ï¼Œç„¡æ³•å†æ¬¡æŠ•ç¥¨ã€‚");
                    return;
                }

                // æ‰¹æ¬¡å¯«å…¥ï¼šåŸå­æ€§åœ°æ›´æ–°å…©è™•è³‡æ–™
                const batch = writeBatch(db);

                // 1. è¨˜éŒ„ä½¿ç”¨è€…æŠ•ç¥¨
                batch.set(userVoteDocRef, {
                    candidateId: candidateId,
                    candidateName: candidateName,
                    votedAt: new Date(),
                    userId: userId
                });

                // 2. æ›´æ–°å€™é¸äººå¾—ç¥¨æ•¸
                const candidateDoc = await getDoc(candidateDocRef);
                const currentVotes = (candidateDoc.exists() ? candidateDoc.data().votes : 0) || 0;
                batch.update(candidateDocRef, { votes: currentVotes + 1 });

                await batch.commit();
                showModal("æŠ•ç¥¨æˆåŠŸï¼");
            } catch (error) {
                console.error("æŠ•ç¥¨å¤±æ•—: ", error);
                showModal("æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // è™•ç†ç®¡ç†å“¡ç™»å…¥
        adminLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLoginSection.style.display = 'none';
                adminPanelSection.style.display = 'block';
                showModal("ç®¡ç†å“¡ç™»å…¥æˆåŠŸã€‚");
            } else {
                showModal("å¯†ç¢¼éŒ¯èª¤ã€‚");
            }
        });

        // è™•ç†æ–°å¢å€™é¸äºº
        addCandidatesBtn.addEventListener('click', async () => {
            if (!db) {
                showModal("è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                return;
            }
            // å°‡è·¯å¾‘æ”¹ç‚ºé ‚å±¤é›†åˆ
            const candidatesCollectionRef = collection(db, `candidates`);
            const names = candidateNamesTextarea.value.split('\n').map(name => name.trim()).filter(name => name);
            if (names.length === 0) {
                showModal("è«‹è¼¸å…¥è‡³å°‘ä¸€ä½å€™é¸äººå§“åã€‚");
                return;
            }
            try {
                const batch = writeBatch(db);
                for (const name of names) {
                    const newCandidateDoc = doc(candidatesCollectionRef); // è‡ªå‹•ç”ŸæˆID
                    batch.set(newCandidateDoc, {
                        name: name,
                        votes: 0
                    });
                }
                await batch.commit();
                showModal("å€™é¸äººå·²æˆåŠŸæ–°å¢ã€‚");
                candidateNamesTextarea.value = '';
            } catch (error) {
                console.error("æ–°å¢å€™é¸äººå¤±æ•—: ", error);
                showModal("æ–°å¢å€™é¸äººå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        });

        // è™•ç†æ¸…ç©ºè³‡æ–™
        clearDataBtn.addEventListener('click', () => {
            showModal("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨è³‡æ–™å’Œå€™é¸äººå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚", true, async () => {
                if (!db) {
                    showModal("è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    return;
                }
                // å°‡è·¯å¾‘æ”¹ç‚ºé ‚å±¤é›†åˆ
                const candidatesCollectionRef = collection(db, `candidates`);
                const usersCollectionRef = collection(db, `users`);

                try {
                    const batch = writeBatch(db);
                    // åˆªé™¤æ‰€æœ‰å€™é¸äºº
                    const candidatesSnapshot = await getDocs(candidatesCollectionRef);
                    candidatesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    // åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…æŠ•ç¥¨è¨˜éŒ„
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    usersSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    showModal("æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¸…ç©ºã€‚");
                } catch (error) {
                    console.error("æ¸…ç©ºè³‡æ–™å¤±æ•—: ", error);
                    showModal("æ¸…ç©ºè³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            });
        });

        // åœ¨é é¢åŠ è¼‰æ™‚åŸ·è¡Œèº«ä»½é©—è­‰
        window.onload = authenticateUser;
    </script>
</body>

</html>
