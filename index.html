<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上即時投票系統</title>
    <!-- 使用 Tailwind CSS 以實現響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 Font Awesome 圖示庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* 自定義長條圖動畫效果 */
        .bar-chart-bar {
            transition: width 0.5s ease-in-out;
        }

        /* 自定義彈出視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- 標題區塊 -->
        <header class="text-center my-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">線上即時投票系統</h1>
            <p class="mt-2 text-md md:text-lg text-gray-600">請從以下候選人中選擇。</p>
        </header>

        <!-- 投票區塊 -->
        <section id="voting-section" class="mb-12">
            <div id="candidates-grid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 justify-center">
                <!-- 候選人卡片將由 JavaScript 動態生成 -->
            </div>
        </section>

        <!-- 投票結果區塊 -->
        <section id="results-section" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">即時投票結果</h2>
            <div id="results-placeholder" class="text-center text-gray-500 text-lg py-4" style="display: none;">
                尚無投票結果。
            </div>
            <div id="bar-chart-container" class="space-y-4">
                <!-- 長條圖將由 JavaScript 動態生成 -->
            </div>
        </section>

        <!-- 管理面板區塊 -->
        <section id="admin-login" class="bg-gray-200 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">管理面板</h2>
            <div class="flex flex-col items-center">
                <input type="password" id="admin-password" placeholder="請輸入密碼"
                    class="p-2 border border-gray-300 rounded-md w-full max-w-sm mb-4 text-center">
                <button id="admin-login-btn"
                    class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors w-full max-w-sm">登入管理員</button>
            </div>
        </section>

        <section id="admin-panel" class="bg-gray-200 p-6 rounded-lg shadow-lg mt-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">管理面板</h2>
            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <div class="flex-grow">
                    <textarea id="candidate-names" rows="5"
                        class="p-2 border border-gray-300 rounded-md w-full resize-none"
                        placeholder="輸入候選人姓名，每行一個&#10;例如:&#10;王小明&#10;陳大華"></textarea>
                    <button id="add-candidates-btn"
                        class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition-colors w-full mt-2">新增候選人</button>
                </div>
                <div class="flex-shrink-0 mt-4 md:mt-0">
                    <button id="clear-data-btn"
                        class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-colors w-full h-full">清空所有資料</button>
                </div>
            </div>
        </section>
    </div>

    <!-- 自定義彈出視窗（取代 alert） -->
    <div id="modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center flex flex-col">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-close-btn"
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">確認</button>
                <button id="modal-cancel-btn"
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors"
                    style="display: none;">取消</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 在這裡替換成您自己的 Firebase 專案設定
        // 您可以在 Firebase Console 中找到這些資訊：專案設定 > 您的應用程式
        const firebaseConfig = {
            apiKey: "AIzaSyAury4xL1VDeszAT8fYTvtyrmHGEFpcp4Y",
            authDomain: "poll-76c08.firebaseapp.com",
            projectId: "poll-76c08",
            storageBucket: "poll-76c08.firebasestorage.app",
            messagingSenderId: "626238322094",
            appId: "1:626238322094:web:98a6dfd2b4eb1fa1ae443f"
        };
        const appIdentifier = "1:626238322094:web:98a6dfd2b4eb1fa1ae443f";
        
        // 初始化 Firebase
        let app, db, auth;
        let userId = '';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase 應用程式與 Firestore 已初始化。");
        } catch (error) {
            console.error("初始化 Firebase 失敗: ", error);
        }

        // DOM 元素快取
        const candidatesGrid = document.getElementById('candidates-grid');
        const barChartContainer = document.getElementById('bar-chart-container');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginSection = document.getElementById('admin-login');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminPanelSection = document.getElementById('admin-panel');
        const addCandidatesBtn = document.getElementById('add-candidates-btn');
        const candidateNamesTextarea = document.getElementById('candidate-names');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // 管理員密碼
        const ADMIN_PASSWORD = "weses3974893";

        // 顯示自定義彈出視窗
        function showModal(message, isConfirmation = false, onConfirm = null) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';

            if (isConfirmation) {
                modalCloseBtn.textContent = '確定清除';
                modalCancelBtn.style.display = 'inline-block';
                // 移除舊的事件監聽器以避免重複觸發
                modalCloseBtn.onclick = null;
                modalCancelBtn.onclick = null;
                modalCloseBtn.onclick = () => {
                    modal.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
                modalCancelBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modalCloseBtn.textContent = '確認';
                modalCancelBtn.style.display = 'none';
                modalCloseBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            }
        }

        // 監聽 Firebase 身份驗證狀態變化
        async function authenticateUser() {
            try {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("用戶已驗證，ID:", userId);
            } catch (error) {
                console.error("身份驗證失敗: ", error);
                userId = crypto.randomUUID();
                console.log("身份驗證失敗，使用隨機 ID:", userId);
            }

            // 啟動 Firestore 監聽器
            startFirestoreListeners();
        }

        // 啟動 Firestore 監聽器以實現即時更新
        function startFirestoreListeners() {
            if (!db || !userId) {
                console.error("Firestore 或用戶ID不可用。");
                return;
            }

            // 更新路徑以符合 Firebase 規範
            const candidatesCollection = collection(db, `voting/candidates`);
            
            // 監聽候選人資料的即時變化
            onSnapshot(candidatesCollection, (snapshot) => {
                const candidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI(candidates);
            }, (error) => {
                console.error("監聽候選人資料失敗: ", error);
            });
        }

        // 更新使用者介面（候選人卡片和長條圖）
        function updateUI(candidates) {
            // 更新候選人卡片
            candidatesGrid.innerHTML = '';
            candidates.forEach(candidate => {
                const card = createCandidateCard(candidate);
                candidatesGrid.appendChild(card);
            });

            // 更新長條圖
            renderBarChart(candidates);
        }

        // 渲染長條圖
        function renderBarChart(candidates) {
            barChartContainer.innerHTML = '';
            if (candidates.length === 0 || candidates.every(c => c.votes === 0)) {
                resultsPlaceholder.style.display = 'block';
                return;
            } else {
                resultsPlaceholder.style.display = 'none';
            }

            const totalVotes = candidates.reduce((sum, c) => sum + (c.votes || 0), 0);
            candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

            candidates.forEach(candidate => {
                const voteCount = candidate.votes || 0;
                const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;

                const barElement = document.createElement('div');
                barElement.className = 'flex items-center space-x-4';
                barElement.innerHTML = `
                    <div class="w-1/4 text-right pr-4 text-gray-700 font-medium">${candidate.name}</div>
                    <div class="relative w-3/4 bg-gray-300 rounded-lg h-8">
                        <div class="bar-chart-bar bg-blue-500 rounded-lg h-full absolute left-0 top-0" style="width: ${percentage}%;"></div>
                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-white text-sm font-bold drop-shadow-md">
                            ${voteCount} 票 (${percentage.toFixed(1)}%)
                        </span>
                    </div>
                `;
                barChartContainer.appendChild(barElement);
            });
        }

        // 隨機產生十六進位顏色代碼
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 建立候選人卡片 DOM 元素
        function createCandidateCard(candidate) {
            const firstChar = candidate.name.charAt(0);
            const randomColor = getRandomColor();
            const imageUrl = `https://placehold.co/96x96/${randomColor}/FFFFFF?text=${encodeURIComponent(firstChar)}`;

            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center';
            card.innerHTML = `
                <div class="w-24 h-24 rounded-full overflow-hidden flex items-center justify-center text-3xl text-gray-600 mb-4">
                    <img src="${imageUrl}" alt="${candidate.name}" class="w-full h-full object-cover">
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">${candidate.name}</h3>
                <button data-candidate-id="${candidate.id}"
                    class="vote-btn bg-blue-500 text-white px-6 py-2 rounded-full hover:bg-blue-600 transition-colors">
                    投票
                </button>
            `;
            const voteBtn = card.querySelector('.vote-btn');
            voteBtn.addEventListener('click', () => handleVote(candidate.id, candidate.name));
            return card;
        }

        // 處理投票邏輯
        async function handleVote(candidateId, candidateName) {
            if (!userId) {
                showModal("正在驗證身份，請稍後再試。");
                return;
            }

            // 更新路徑以符合 Firebase 規範
            const userVoteDocRef = doc(db, `voting/users/${userId}`);
            const candidateDocRef = doc(db, `voting/candidates/${candidateId}`);

            try {
                // 檢查使用者是否已投票
                const userVoteDoc = await getDoc(userVoteDocRef);
                if (userVoteDoc.exists()) {
                    showModal("您已經投過票了，無法再次投票。");
                    return;
                }

                // 批次寫入：原子性地更新兩處資料
                const batch = writeBatch(db);

                // 1. 記錄使用者投票
                batch.set(userVoteDocRef, {
                    candidateId: candidateId,
                    candidateName: candidateName,
                    votedAt: new Date(),
                    userId: userId
                });

                // 2. 更新候選人得票數
                const candidateDoc = await getDoc(candidateDocRef);
                const currentVotes = (candidateDoc.exists() ? candidateDoc.data().votes : 0) || 0;
                batch.update(candidateDocRef, { votes: currentVotes + 1 });

                await batch.commit();
                showModal("投票成功！");
            } catch (error) {
                console.error("投票失敗: ", error);
                showModal("投票失敗，請稍後再試。");
            }
        }

        // 處理管理員登入
        adminLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLoginSection.style.display = 'none';
                adminPanelSection.style.display = 'block';
                showModal("管理員登入成功。");
            } else {
                showModal("密碼錯誤。");
            }
        });

        // 處理新增候選人
        addCandidatesBtn.addEventListener('click', async () => {
            if (!db) {
                showModal("資料庫未初始化，請稍後再試。");
                return;
            }
            // 更新路徑以符合 Firebase 規範
            const candidatesCollection = collection(db, `voting/candidates`);
            const names = candidateNamesTextarea.value.split('\n').map(name => name.trim()).filter(name => name);
            if (names.length === 0) {
                showModal("請輸入至少一位候選人姓名。");
                return;
            }
            try {
                const batch = writeBatch(db);
                for (const name of names) {
                    const newCandidateDoc = doc(candidatesCollection); // 自動生成ID
                    batch.set(newCandidateDoc, {
                        name: name,
                        votes: 0
                    });
                }
                await batch.commit();
                showModal("候選人已成功新增。");
                candidateNamesTextarea.value = '';
            } catch (error) {
                console.error("新增候選人失敗: ", error);
                showModal("新增候選人失敗，請稍後再試。");
            }
        });

        // 處理清空資料
        clearDataBtn.addEventListener('click', () => {
            showModal("確定要清空所有投票資料和候選人嗎？此操作無法撤銷。", true, async () => {
                if (!db) {
                    showModal("資料庫未初始化，請稍後再試。");
                    return;
                }
                // 更新路徑以符合 Firebase 規範
                const candidatesCollection = collection(db, `voting/candidates`);
                const usersCollection = collection(db, `voting/users`);

                try {
                    const batch = writeBatch(db);
                    // 刪除所有候選人
                    const candidatesSnapshot = await getDocs(candidatesCollection);
                    candidatesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    // 刪除所有使用者投票記錄
                    const usersSnapshot = await getDocs(usersCollection);
                    usersSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    showModal("所有資料已成功清空。");
                } catch (error) {
                    console.error("清空資料失敗: ", error);
                    showModal("清空資料失敗，請稍後再試。");
                }
            });
        });

        // 在頁面加載時執行身份驗證
        window.onload = authenticateUser;
    </script>
</body>

</html>
